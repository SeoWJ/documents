# RedHat Openstack 교육

- 김주효 강사 / juhyokim@nobreak.co.kr
- RedHat Openstack 16 version
- RHCSA 자격증이 있어야 오픈스택 자격증 취득 가능.

## Chapter 0. 환경

### 인프라 환경 구성요소
- P9 장표 참조
- bastion : 외부와 연결하는 관리용 시스템. 라우터 역할도 수행. 실습에서는 사실상 라우터라고 봐도 좋다.
- workstation : 오픈스택과는 상관없는 시스템. 평소 서버/시스템 관리하는 시스템이라고 봐도 됨. 평소 사용하는 노트북 같은거라 봐도 좋다. 보통 CLI 이기 때문에 GUI쓰고 싶을 때 이걸 쓰면 된다.
- director
    - 레드햇 오픈스택은 플랫환경이 아니라 계층구조로 구성된다.
    - undercloud : 디렉터 + 네트워크구성까지 언더클라우드라 본다.
    - 계층적으로 구성하는 이유는 오버클라우드라는 환경은 사용자에게 서비스를 제공하기 위한 환경. 이 서비스들을 하나하나 직접설치하기 귀찮으니까 디렉터를 통해 일괄적으로 배포/관리가 가능.
    - 플랫환경 : 디렉터 없이 오버클라우드 구성만 있는 환경.
- power : 계층구성을 할 때 필수. 이름 그대로 파워관리를 해줌. IPMI. 노드들을 원격으로 전원관리 가능하게 만들어 둔 시스템.
- utility : 도구 제공 시스템. 실습환경은 유틸리티 시스템에서 레드햇 idm이란 서비스 사용. 일반적으로는 IPA, LDAP라고 부름(외부 디렉토리 서비스). 오버클라우드에서 사용하는 DNS서비스도 여기에 정의된다.
- controller : 이름 그대로 오픈스택환경에서 클라우드 시스템을 관리하는 관리노드. 한대로 그려져있는데 실제 운영환경에서는 클러스터 구성이 필요하다. 저 서버하나 망가지면 박살난다.
- compute : 우리가 실행할 인스턴스.
- ceph0 : 스토리지 구성. 오픈스택 구성할 때 저장공간(스토리지)를 따로 구성하지 않아도 되긴하나, 실제 환경에서는 당연히 따로 구성한다. object스토리지. 3대 이상의 클러스터 구성(한대로만 구성하면 의미 없음). 
* blob : 블록단위로 스토리지를 저장하는 파티션이나 볼륨단위를 만들어 사용하는 방식. 가상머신의 데이터들을 파일 하나로 만들어 저장. 이걸 블롭스토리지라 한다.
* object storage : 나는 파일을 하나 저장하는데, 이를 여러 데이터 단위로 쪼개서 데이터 하나를 저장하는데도 단순 저장이 아니라 복제를 해서 여러 스토리지에 같은 데이터를 저장.

- 네트워크는 3종류. 익스터널, 매니지먼트, 프로비저닝
- 익스터널과 인터널을 라우터를 통해 연결할 것. 그 시스템과 연결된 네트워크를 External이라 한다.
- Management 네트워크
    - 스토리지 관리용 / api관리용 등으로 나뉨. VLAN으로 쪼개서 관리.
    - 오버클라우드끼리만 연결되어 있다. 관리는 컨트롤러를 통해 나머지를 관리하기에 같이 연결될 필요가 없다.
- Provisioning 네트워크
    - 디렉터 네트워크가 연결되어 있다.

### 네트워크 구성
- P11 장표
- 인터널, 테넌트(프로젝트) : 컴퓨트에만 연결되어 있음.
- 스토리지 매니지먼트 : 컴퓨트와 스토리지에만 연결되어 있음.
- 매니지먼트 : 전부다

### 오픈스택 부팅
- director 환경에서
    - `source ~/overcloudrc` : 오버클라우드 환경으로 변경
    - `source stackrc` : 언더클라우드 환경으로 변경
    - `openstack compute service list`  : 활성화 된 서비스 리스트 출력
    - `openstack baremetal node list` : 컨트롤러 컴퓨트 셰프 시스템에 대해 부팅상태 확인 가능
    - `openstack baremetal node power on <이름>` : 부팅을 해주는 명령어. 부팅할때 IPMI를 통해서 부팅 명령어 전달
    - `ssh controller0` : 컨트롤러 접속
    - `sudo pcs cluster start --all` : PCS명령어로 클러스터를 활성화 하겠다. 컨트롤러 최초 부팅후에는 클러스터부터 활성화해야함
    - `sudo podman ps` : 실행된 컨테이너 목록 확인. ceph-mon-controller0에서 작업 해야 한다.
    - `sudo -i`로 루트 변환후 `podman exec chep-mon-controller0 ceph osd unset noout` : 컨테이너 내부에 뒤의 명령어 전달
    - `ceph ost unset XXX` : 셰프 클러스터 명령어들 플래그들 비활성화. 오브젝트 스토리지 기반으로 백업등의 기능이 동작하게 되어있다. 정상 종료시에는 저걸 다 비활성화 해야함.
        - noout
        - norecover
        - norebalance
        - nobackfill
        - nodown
        - pause
    - exit두번 진행하여 루트에서 빠져나가고 디렉터로 다시 돌아와서 undercloud환경에서 `openstack baremetal node power on compute0/compute1` : vm부팅.
    - 마지막으로 키오스크로 나가서 `rht-vmctl start all` : 아침에 오면 매일 이걸 해줘야 한다.

    - 순서대로 정리하자면,
        - director power
        - director에서 ceph 부팅
        - director에서 controller 부팅
        - 이 두가지 시스템은 부팅 순서 무관. 둘다 부팅된 이후 클러스터 활성화
        - ceph스토리지에 대한 플래그 설정
        - director에서 컴퓨트 실행
    - 종료할때는 역순. 플래그 설정할 때는 unset을 set으로 적용하면 된다.

    - `rht-vmctl XXX`
        - start : 부팅할 때 사용. 아침에 부팅할 때
        - reset : 잘못설정하거나 할 때 리셋. 현재상태로 되돌아간다. all을 추가로 입력하면 전체선택. undercloud, overcloud등으로 그룹적용도 가능하다.

### lab. 실습/연습 환경 제공
- ssh student@workstation에 접속하여 입력한다.
- `lab XXX start`
    - start : 시작
    - grade : 채점할때.
    - finish : 실습한 내용 제거


## Chapter 1. Red Hat Openstack Platform 소개

### 가상 사용자
- P3 장표 참조.
- 가상 사용자 : 인프라 환경을 접하는 우리를 의미. 엔지니어, 운영자, 개발자, 일반 사용자 모두를 포함.
- 우리가 진행하는 이 과정의 주요 대상은 Domain Operator 기준으로 많이 설명되어 있다.
- 제일 가운데, 로우레벨에 있는 사람들이 데이터센터를 관리하는 사람. 그 다음으로 물리적인 인프라를 관리하는 사람. 우리는 이 영역은 다루지 않는다.
- Domain Operator : 구성되어있는 오픈스택 환경을 운영하는 사람들.
    - 프로젝트(작업 단위. 내가 사용하려는 리소스들의 그룹을 의미. 옛날 용어로 Tenent) 생성 및 관리.
    - 사용자 및 사용자 역할 할당.
    - 도메인에서 리소스와 기타 작업 관리.
        - 도메인이 상위개념. 도메인이 클라우드 환경이라고 봐도 무방하다.
        - 고객마다 각각의 도메인을 분리하여 제공한다.
    - 프로젝트 - 리소스 및 배포된 애플리케이션 격리
    - 하나 이상의 오픈스택 ID 서비스 도메인에 속함
    - 도메인 - 사용자, 프로젝트, 리소스 포함
    - 여러 도메인 지원
    - 직접 설치하지는 않지만 요구사항 이해 필요
    - 클라우드 사용자 지원을 위한 경험 및 기본지식 필요

- 도메인 운영자가 지원하는 다른 가상 사용자
    - 애플리케이션 개발자
        - 일반 사용자라 봐도 무방하다.
        - 코드 개발자, 유지관리자, 기타 클라우드 사용자
    - 프로젝트 소유자
        - 도메인 운영자로부터 관리 권한 위임
        - 프로젝트 별 사용자 및 역할 할당 관리

- 가상 사용자 별 설명
    - 프로젝트 소유자 : 애플리케이션의 개발 또는 유지관리를 관리할 책임이 있음.
    - 인프라 아키텍트 : 분배된 Overcloud 배포 용량 및 구성 설계
    - 도메인 관리자 : 리소스 할당, 사용자 액세스 및 배포 지원 관리
    - 서비스 관리자 : 오픈스택 인프라 리소스 구성 요소를 구현, 지원 및 확장.

### 인스턴스 시작
- 대부분의 명령어는 `openstack`으로 시작
- 일반적으로 `openstack <관리대상> <동작>`의 순서로 되어있음.
- 인증을 마친 사용자에게 접근 권한을 부여하며, 인증에 필요한 값은 환경변수 or 매개변수로 제공(환경 변수 권장)
- `cat <유저명>-finance-rc` 명령어로 사용자 정보를 확인할 수 있다.
    - OS_USERNAME : 사용자 이름
    - OS_PASSWORD : 패스워드
    - OS_PROJECT_DOMAIN_NAME : 도메인이란 프로젝트와 사용자에 대한 상위 개념. 도메인을 여러개 사용하는 경우 지금의 프로젝트가 어느 도메인에 있는지에 대한 정보.
    - OS_PROJECT_NAME : 프로젝트의 이름.
    - OS_IMAGE_API_VERSION
    - OS_IDENTITY_API_VERSION : 대부분 요즘은 3버전 사용. 2일 경우 도메인이라는 개념을 사용하지 않는다는 문제점이 있다. 또한 오픈스택도 리눅스와 마찬가지로 사용자와 그룹이 있는데 2에는 그룹이 없다.
    - OS_AUTH_URL : 인증 서버의 주소. 사용자 이름, 패스워드 등을 어디를 통해 인증하겠다는 정보. 일반적으로 컨트롤러 노드에서 동작하므로 컨트롤러 노드의 ip주소와 동일.
    
- `source admin-rc` or `source <유저명>-finance-rc` 명령어로 접속하여 사용한다. 이 과정이 인증이며, 이 과정 없이 명령어를 사용하면 실행되지 않는다.
- `openstack`이라고 입력하면 명령어에 대한 리스트를 확인할 수 있다.

- 명령어 리스트
    - `openstack project list` : 프로젝트의 리스트를 출력해준다.
        - admin : 관리용 프로젝트
        - service : 오픈스택 내부에서 동작하는 각 서비스들이 동작하는데 있어 필요한 프로젝트. 있는지만 보면 됨. 쓰지는 않는다.
        - 그 외 : 필요할 때마다 그때그때 만들어서 사용.
    - `openstack project list --help` : 출력방식이 맘에 안들 때 줄수있는 인자 리스트에 대한 도움말들을 출력
    - `openstack network list` : id, name, subnet을 출력.
    
    - 출력형식 변경
        - `--fit-width` : 가로 길이를 맞춰준다.
        - `--domain` : 도메인만 출력
        - `-f` : 출력 방식 결정. csv, json, yaml 등을 설정할 수 있다. 기본적으로는 테이블로 출력.
        - `--max-width` : 행 넓이를 제한할 수 있다.
        - `-c` : 컬럼인 경우 아이디만 보겠다. 각 컬럼별로 가지고있는 아이디들은 알고있어야 쓰겠지?

- 프로젝트를 사용하여 애플리케이션 및 네트워크 관리
    - admin 권한을 가진 사용자만 가능
    - 어떤 사용자에 대해 어떤 역할을 할당한다의 방식으로 수행하게 될 것.
    - member : 관리자는 아니고 일반적인 사용자를 의미한다.
    - 많은 부분은 멤버로도 작업이 가능하다. 일부 부분의 경우에만 어드민 권한이 필요하다.

- 인스턴스 : 클라우드에서 사용하는 가상머신을 지칭하는 용어.
    - 인스턴스는 사용하는 데이터들을 임시 스토리지를 이용하여 저장하도록 되어있다. 아예 휘발성 데이터란 의미는 아니고 인스턴스를 유지하는 동안은 유지되는 공간이다. 인스턴스 삭제시 데이터도 같이 삭제된다.
    - 영구 스토리지 : 필요에 따라 연결할 수 있는데, 인스턴스를 지워도 데이터를 남겨둘 수 있다.
    - 이미지 : 인스턴스를 만들 때 필요한 개체들 중 하나로, 가상머신이 동작할 수 있게 해주는 디스크 파일이다. 포맷은 RAW or QCOW2 사용. 이미지를 업로드 및 저장은 멤버도 가능하나 공용으로 사용하는 이미지는 어드민만 가능하다.
    - 플레이버 : 인스턴스의 계산, 메모리 및 스토리지 용량을 지정. 어드민만 플레이버를 생성할 수 있다. 멤버는 선택만 가능. 
    - `openstack server create --image rhel8 --flaver small --network finance-network1 --wait finance-server1` 인스턴스 생성 명령어 예시.
        - wait 옵션의 경우 내가 명령어를 실행하면 실행되고 나서 실제 인스턴스가 만들어질때까지 기다리겠다는 의미. 이걸 설정 안하면 만들어졌을때 프롬프트가 생성되고 나서 인스턴스가 잘 실행되고 났을 때 응답이 와서 새 프롬프트가 뜬다. 급한게 아니라면 쓰는게 좋다. 만들어졌다고 생각했는데 오류가 발생했을 수도 있으므로.

- 인스턴스 콘솔에 액세스
    - 당연히 콘솔을 쓰려면 GUI환경이어야 한다.
    - `openstack console url show` 명령으로 주소 확인
    - `openstack console log show <SERVER_ID>` : 로그를 띄워준다. 부팅과정에서 어떤걸 설정했는지 등을 볼 수 있다.

- Openstack 대시보드에서 리소스 관리
    - 브라우저를 이용하여, http://dashboard.overcloud.example.com 강의실의 경우는 여기서 확인할 수 있다.
    - 사용자는 Domain : default / ID : admin / PW : redhat으로 접속 가능
    - compute - instances - launch instance 버튼으로 인스턴스 생성 가능.

### Openstack 플랫폼 서비스 설명
- Cinder
    - 블록 스토리지 서비스.
    - 우리가 사용하는 인스턴스들이 추가적인 저장공간이 필요하다 할 때 연결해 주는 서비스.

- Glance
    - 이미지 서비스.
    - 우리가 사용할 이미지 파일들을 관리.
    - 이미지 : 내가 사용할 인스턴스가 어떤 운영체제를 쓸 것인지, 어떤 프로그램을 쓸 것인지에 관한 것.

- Heat
    - 오케스트레이션 서비스
    - 편의를 위해 자주 사용하는 서비스
    - 템플릿으로 여러 리소스들을 일괄관리하는 용도

- Horizon
    - 대시보드 서비스
    - 오픈스택 관리 및 인스턴스 시작을 위한 그래픽 인터페이스 제공

- Ironic
    - 베어메탈 프로비저닝 서비스.
    - 물리 하드웨어를 프로비저닝 (PXE, IPMI 드라이버 제공)

- Keystone
    - ID 관리 서비스
    - 가장 중요한 서비스라 볼 수 있다.
    - 인증 및 권한 부여를 담당하는 서비스
    - 도메인으로 경계 구분

- Neutron
    - 네트워킹 서비스
    - SDN으로 인스턴스/라우터/네트워크 등 연결 구성
    - 시큐리티 그룹 설정
    - floating ip 설정

- Nova
    - 컴퓨트 서비스
    - 우리가 사용할 인스턴스에 대한 관리를 제공.
    - 인스턴스를 어떤 노드에서 실행하는지 선택. 선택했으면 배치하고 동작하고 실행할 수 있도록 해주는 부분. 이후 관리까지 모두 담당.
    - 하이퍼바이저에 libirth, qemu, kvm 사용.

- Swift
    - 오브젝트 저장소 서비스.
    - 오브젝트 스토리지 관리.
    - 수평적 확장과 이중화 제공을 위해 분산 구조 사용.
    - 이미지 서비스의 스토리지 백엔드로 사용 가능
    - 레드햇 오픈스택은 Ceph로 대체되어 사용.

- Placement
    - 배치 서비스.
    - 클라우드 리소스 인벤토리 및 사용을 추적해 리소스의 효율적인 관리 지원.

- Manila
    - 공유 파일 시스템 서비스.

※ 스토리지 종류별
    - 인스턴스를 만들어 사용하는데 있어서 인스턴스에 저장공간을 만드는 것은 블록 스토리지.
    - 인스턴스와 상관없이 내가 개인적으로 저장하거나 오픈스택을 하면서 따로 사용하는데 쓸거는 오브젝트 스토리지
    - 블록스토리지는 한번에 하나밖에 연결이 안됨. 한 블록을 인스턴스 여러개에 동시에 연결하는건 기본적으로 안된다. 이걸 가능하게 하는 서비스가 마닐라.

- Telemetry Service
    - Ceilometer라는 이름의 서비스를 사용.
    - Ceilometer는
        - Aodh
        - gnochi
        - panko
        - 이상의 3가지 서비스로 세분화
    - 오픈스택환경에서 어떤 인스턴스가 얼마나의 리소스를 쓰는지 사용량 측정 및 과금 정책 관여

- Kolla
    - 컨테이너 배포 서비스.
    - Ansible로 자동화.

- Octavia
    - 부하분산 서비스
    - HAProxy 사용.

- TripleO
    - 배포 서비스.
    - 배포, 운영 모니터링, 업그레이드 기능까지 제공.